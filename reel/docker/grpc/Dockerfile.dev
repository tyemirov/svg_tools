FROM ghcr.io/astral-sh/uv:python3.12-bookworm AS builder

WORKDIR /app
COPY . /app
RUN uv run --no-project /app/audio_to_text.py --help >/dev/null \
  && uv run --no-project /app/grpc_server.py --help >/dev/null

FROM python:3.12-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    ffmpeg \
    patchelf \
    make \
    ca-certificates \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY --from=builder /usr/local/bin/uv /usr/local/bin/uv
COPY --from=builder /root/.cache/uv /root/.cache/uv

ENTRYPOINT ["/app/docker/grpc/entrypoint.sh"]
